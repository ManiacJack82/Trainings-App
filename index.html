<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainings App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1HsJvWIYnBPCqSQS0ymOL0IEdZW8KDOY",
      authDomain: "trainings-app-24eb7.firebaseapp.com",
      projectId: "trainings-app-24eb7",
      storageBucket: "trainings-app-24eb7.appspot.com",
      messagingSenderId: "266317486009",
      appId: "1:266317486009:web:730e7f91eaae69fb584868",
      measurementId: "G-3EWQ7W9Z85",
      databaseURL: "https://trainings-app-24eb7-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase(app);

    const email = prompt("E-Mail eingeben:");
    const pass = prompt("Passwort eingeben:");
    signInWithEmailAndPassword(auth, email, pass)
      .then(() => console.log("Angemeldet"))
      .catch(err => alert("Login-Fehler: " + err.message));

    const eintraege = [];
    const uebungen = [];

    const geraetSelect = document.getElementById('geraetSelect');
    const wdhInput = document.getElementById('wdh');
    const gewichtInput = document.getElementById('gewicht');
    const tbody = document.querySelector('#tabelle tbody');
    const tabelle = document.getElementById('tabelle');
    const trainingForm = document.getElementById('trainingForm');
    let geraetChart, wochenChart;

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'statsTab') {
        renderCharts();
      }
    }

    document.getElementById('hinzufuegenUebung').onclick = () => {
      const name = document.getElementById('neueUebung').value.trim();
      if (name && !uebungen.includes(name)) {
        uebungen.push(name);
        updateUebungen();
        document.getElementById('neueUebung').value = '';
      }
    };

    function updateUebungen() {
      geraetSelect.innerHTML = '';
      uebungen.forEach(uebung => {
        const opt = document.createElement('option');
        opt.textContent = uebung;
        opt.value = uebung;
        geraetSelect.appendChild(opt);
      });
      geraetSelect.selectedIndex = -1;
      updateUebungenList();
    }

    function updateUebungenList() {
      const list = document.getElementById('uebungenList');
      list.innerHTML = '';
      uebungen.forEach((uebung, index) => {
        const li = document.createElement('li');
        li.textContent = uebung;
        const btn = document.createElement('button');
        btn.textContent = 'L√∂schen';
        btn.onclick = () => {
          uebungen.splice(index, 1);
          updateUebungen();
        };
        li.appendChild(btn);
        list.appendChild(li);
      });
    }

    document.getElementById('toggleUebungen').onclick = () => {
      document.getElementById('uebungenContainer').classList.toggle('collapsed');
    };

    geraetSelect.onchange = () => {
      const eintraegeZuUebung = eintraege.filter(e => e.geraet === geraetSelect.value);
      if (eintraegeZuUebung.length) {
        const letzter = eintraegeZuUebung[0];
        wdhInput.value = letzter.wdh;
        gewichtInput.value = letzter.gewicht;
      } else {
        wdhInput.value = '';
        gewichtInput.value = '';
      }
    };

    trainingForm.onsubmit = e => {
      e.preventDefault();
      const now = new Date();
      const datum = now.toLocaleDateString('de-DE') + ' ' + now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      const geraet = geraetSelect.value;
      const wdh = Number(wdhInput.value);
      const gewicht = Number(gewichtInput.value);

      const eintrag = { datum, geraet, wdh, gewicht };
      eintraege.unshift(eintrag);

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${datum}</td>
        <td>${geraet}</td>
        <td>${wdh}</td>
        <td>${gewicht} kg</td>
        <td><button onclick="this.closest('tr').remove()">üóëÔ∏è</button></td>
      `;
      tbody.prepend(row);

      tabelle.hidden = false;
      trainingForm.reset();
      geraetSelect.selectedIndex = -1;

      const userId = auth.currentUser.uid;
      const eintragRef = push(ref(db, `users/${userId}/eintraege`));
      set(eintragRef, eintrag);
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        const eintraegeRef = ref(db, `users/${user.uid}/eintraege`);
        onValue(eintraegeRef, snapshot => {
          eintraege.length = 0;
          tbody.innerHTML = '';
          snapshot.forEach(child => {
            const e = child.val();
            eintraege.unshift(e);
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${e.datum}</td>
              <td>${e.geraet}</td>
              <td>${e.wdh}</td>
              <td>${e.gewicht} kg</td>
              <td><button onclick="this.closest('tr').remove()">üóëÔ∏è</button></td>
            `;
            tbody.appendChild(row);
          });
          tabelle.hidden = eintraege.length === 0;
        });
      }
    });

    function renderCharts() {
      const geraeteDaten = {};
      const wochen = {};

      eintraege.forEach(e => {
        const d = new Date(e.datum.split(' ')[0].split('.').reverse().join('-'));
        const kw = `${d.getFullYear()}-W${Math.ceil((d.getDate() + 6 - d.getDay()) / 7)}`;
        wochen[kw] = (wochen[kw] || 0) + 1;
        geraeteDaten[e.geraet] = geraeteDaten[e.geraet] || [];
        geraeteDaten[e.geraet].push({ x: e.datum, y: e.gewicht });
      });

      const geraetCtx = document.getElementById('geraetChart').getContext('2d');
      if (geraetChart) geraetChart.destroy();
      geraetChart = new Chart(geraetCtx, {
        type: 'line',
        data: {
          datasets: Object.keys(geraeteDaten).map(name => ({
            label: name,
            data: geraeteDaten[name],
            fill: false,
            borderColor: '#' + Math.floor(Math.random()*16777215).toString(16)
          }))
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'Gewichtsverlauf pro Ger√§t' } },
          scales: { x: { type: 'category', title: { display: true, text: 'Datum' } }, y: { title: { display: true, text: 'kg' } } }
        }
      });

      const wochenCtx = document.getElementById('wochenChart').getContext('2d');
      if (wochenChart) wochenChart.destroy();
      wochenChart = new Chart(wochenCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(wochen),
          datasets: [{
            label: 'Trainings/Woche',
            data: Object.values(wochen),
            backgroundColor: '#00c896'
          }]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'Trainingsh√§ufigkeit pro Woche' } },
          scales: { y: { beginAtZero: true, title: { display: true, text: 'Anzahl' } } }
        }
      });
    }
  </script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
      color: #fff;
      padding: 10px;
      max-width: 500px;
      margin: auto;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    /* Weitere Styles wie im urspr√ºnglichen Code */
  </style>
</head>
<body>
  <h1>Trainings App</h1>
  <div class="tabs">
    <div class="tab-header">
      <button onclick="switchTab('statsTab')">üìä Statistiken</button>
      <button onclick="switchTab('formTab')">üìã Training</button>
    </div>
    <div id="statsTab" class="tab-content">
      <canvas id="geraetChart"></canvas>
      <canvas id="wochenChart"></canvas>
    </div>
    <div id="formTab" class="tab-content active">
      <div class="custom-section" id="uebungenContainer">
        <h3>√úbung hinzuf√ºgen</h3>
        <input id="neueUebung" placeholder="Name der √úbung" />
        <button id="hinzufuegenUebung">Hinzuf√ºgen</button>
        <button id="toggleUebungen">√úbungsliste ein-/ausklappen</button>
        <ul id="uebungenList"></ul>
      </div>
      <form id="trainingForm">
        <label>Ger√§t:</label>
        <select id="geraetSelect"></select>
        <label>Wiederholungen:</label>
        <input type="number" id="wdh" min="1" />
        <label>Gewicht (kg):</label>
        <input type="number" id="gewicht" min="0" step="0.5" />
        <button type="submit">Eintragen</button>
      </form>
      <table id="tabelle" hidden>
        <thead><tr><th>Datum</th><th>Ger√§t</th><th>Wdh</th><th>Gewicht</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</body>
</html>


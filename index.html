<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trainings App Testversion</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; background: #f0f0f0; }
  h1 { text-align: center; }
  .tabs { margin-top: 1rem; }
  .tab-header { display: flex; justify-content: center; gap: 1rem; }
  .tab-header button {
    padding: 0.5rem 1rem;
    border: none;
    background: #ccc;
    cursor: pointer;
    border-radius: 20px;
    font-weight: bold;
  }
  .tab-header button.active {
    background: #007bff;
    color: white;
  }
  .tab-content { display: none; margin-top: 1rem; background: white; padding: 1rem; border-radius: 8px; }
  .tab-content.active { display: block; }
  label { font-weight: bold; display: block; margin-top: 0.5rem; }
  input, select { width: 100%; padding: 0.3rem; margin-top: 0.2rem; font-size: 1rem; }
  table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  th, td { border: 1px solid #ddd; padding: 0.5rem; text-align: center; }
  th { background: #007bff; color: white; }
  span.arrow-up { color: green; font-weight: bold; }
  span.arrow-down { color: red; font-weight: bold; }
  button.save-btn {
    margin-top: 1rem;
    background: #007bff; color: white; border: none; padding: 0.6rem 1.2rem; font-size: 1rem; border-radius: 4px;
    cursor: pointer;
  }
  button.save-btn:hover { background: #0056b3; }
</style>
</head>
<body>

<h1>Trainings App Testversion</h1>

<div class="tabs">
  <div class="tab-header">
    <button id="tabStatsBtn" class="active">üìä Statistiken</button>
    <button id="tabFormBtn">üìã Training</button>
  </div>

  <div id="statsTab" class="tab-content active">
    <canvas id="geraetChart" height="200"></canvas>
    <canvas id="wochenChart" height="200" style="margin-top: 2rem;"></canvas>
  </div>

  <div id="formTab" class="tab-content">
    <label for="geraetSelect">Ger√§t:</label>
    <select id="geraetSelect">
      <option value="">-- Ger√§t w√§hlen --</option>
      <option>Bankdr√ºcken</option>
      <option>Kniebeugen</option>
      <option>Klimmz√ºge</option>
      <option>Deadlift</option>
      <option>Schulterdr√ºcken</option>
    </select>

    <label for="wdh">Wiederholungen:</label>
    <input type="number" id="wdh" min="1" />

    <label for="gewicht">Gewicht (kg):</label>
    <input type="number" id="gewicht" min="0" step="0.5" />

    <button class="save-btn" id="saveBtn">Eintrag speichern</button>

    <table id="tabelle" style="display:none;">
      <thead>
        <tr>
          <th>Datum</th>
          <th>Ger√§t</th>
          <th>Wdh</th>
          <th>Gewicht</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  // Tab Umschaltung
  const tabStatsBtn = document.getElementById('tabStatsBtn');
  const tabFormBtn = document.getElementById('tabFormBtn');
  const statsTab = document.getElementById('statsTab');
  const formTab = document.getElementById('formTab');

  tabStatsBtn.addEventListener('click', () => {
    tabStatsBtn.classList.add('active');
    tabFormBtn.classList.remove('active');
    statsTab.classList.add('active');
    formTab.classList.remove('active');
    renderCharts();
  });
  tabFormBtn.addEventListener('click', () => {
    tabFormBtn.classList.add('active');
    tabStatsBtn.classList.remove('active');
    formTab.classList.add('active');
    statsTab.classList.remove('active');
  });

  // Elemente
  const geraetSelect = document.getElementById('geraetSelect');
  const wdhInput = document.getElementById('wdh');
  const gewichtInput = document.getElementById('gewicht');
  const saveBtn = document.getElementById('saveBtn');
  const tabelle = document.getElementById('tabelle');
  const tbody = tabelle.querySelector('tbody');

  // Daten speichern in localStorage
  const STORAGE_KEY = 'trainingsAppEintraege';

  let eintraege = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

  function saveEntries() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(eintraege));
  }

  // Tabelle rendern mit Pfeilen
  function renderTable() {
    tbody.innerHTML = '';

    if(eintraege.length === 0) {
      tabelle.style.display = 'none';
      return;
    }
    tabelle.style.display = 'table';

    // letzte Gewichte pro Ger√§t merken
    const lastGewicht = {};

    // Sortiere Eintr√§ge nach Datum absteigend
    eintraege.sort((a,b) => new Date(b.datum) - new Date(a.datum));

    for(const e of eintraege) {
      let pfeil = '';
      const prevGewicht = lastGewicht[e.geraet];

      if(prevGewicht !== undefined) {
        if(e.gewicht > prevGewicht) pfeil = '<span class="arrow-up">&#9650;</span>';
        else if(e.gewicht < prevGewicht) pfeil = '<span class="arrow-down">&#9660;</span>';
      }

      lastGewicht[e.geraet] = e.gewicht;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${new Date(e.datum).toLocaleString()}</td>
        <td>${e.geraet}</td>
        <td>${e.wdh}</td>
        <td>${e.gewicht} kg ${pfeil}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Chart.js Charts
  let geraetChart, wochenChart;

  function renderCharts() {
    if(eintraege.length === 0) {
      if(geraetChart) geraetChart.destroy();
      if(wochenChart) wochenChart.destroy();
      return;
    }

    // Daten pro Ger√§t sammeln (Datum - Gewicht)
    const dataPerGeraet = {};
    // Trainings pro Woche (Jahr-Woche)
    const trainingsPerWeek = {};

    for(const e of eintraege) {
      if(!dataPerGeraet[e.geraet]) dataPerGeraet[e.geraet] = [];
      dataPerGeraet[e.geraet].push({ x: new Date(e.datum), y: e.gewicht });

      const d = new Date(e.datum);
      const year = d.getFullYear();
      const week = getWeekNumber(d);
      const key = `${year}-W${week}`;
      trainingsPerWeek[key] = (trainingsPerWeek[key] || 0) + 1;
    }

    for(const g in dataPerGeraet) {
      dataPerGeraet[g].sort((a,b) => a.x - b.x);
    }

    // Ger√§te Chart
    const ctxG = document.getElementById('geraetChart').getContext('2d');
    if(geraetChart) geraetChart.destroy();
    geraetChart = new Chart(ctxG, {
      type: 'line',
      data: {
        datasets: Object.keys(dataPerGeraet).map(geraet => ({
          label: geraet,
          data: dataPerGeraet[geraet].map(p => ({ x: p.x.toLocaleDateString(), y: p.y })),
          borderColor: randomColor(geraet),
          fill: false,
          tension: 0.2,
          parsing: false
        }))
      },
      options: {
        scales: {
          x: { type: 'category', title: { display: true, text: 'Datum' } },
          y: { beginAtZero: true, title: { display: true, text: 'Gewicht (kg)' } }
        }
      }
    });

    // Trainings pro Woche Chart
    const ctxW = document.getElementById('wochenChart').getContext('2d');
    if(wochenChart) wochenChart.destroy();
    const sortedKeys = Object.keys(trainingsPerWeek).sort();
    wochenChart = new Chart(ctxW, {
      type: 'bar',
      data: {
        labels: sortedKeys,
        datasets: [{
          label: 'Trainings pro Woche',
          data: sortedKeys.map(k => trainingsPerWeek[k]),
          backgroundColor: '#007bff'
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'Anzahl' } },
          x: { title: { display: true, text: 'Kalenderwoche' } }
        }
      }
    });
  }

  // Hilfsfunktion Kalenderwoche ISO 8601
  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
  }

  // Farbe aus String f√ºr Chart
  function randomColor(str) {
    let hash = 0;
    for(let i=0; i < str.length; i++) {
      hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return "#" + "00000".substring(0, 6 - c.length) + c;
  }

  // Speichern Button
  saveBtn.addEventListener('click', () => {
    const geraet = geraetSelect.value;
    const wdh = Number(wdhInput.value);
    const gewicht = Number(gewichtInput.value);

    if(!geraet) { alert('Bitte Ger√§t w√§hlen'); return; }
    if(!wdh || wdh < 1) { alert('Bitte g√ºltige Wiederholungen eingeben'); return; }
    if(isNaN(gewicht) || gewicht < 0) { alert('Bitte g√ºltiges Gewicht eingeben'); return; }

    eintraege.push({
      datum: new Date().toISOString(),
      geraet,
      wdh,
      gewicht
    });

    saveEntries();
    renderTable();

    // Eingabefelder leeren
    geraetSelect.value = "";
    wdhInput.value = "";
    gewichtInput.value = "";

    alert("Eintrag gespeichert!");
  });

  // Initial render
  renderTable();
  renderCharts();

</script>

</body>
</html>

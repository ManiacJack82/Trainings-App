<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trainings App</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1HsJvWIYnBPCqSQS0ymOL0IEdZW8KDOY",
      authDomain: "trainings-app-24eb7.firebaseapp.com",
      projectId: "trainings-app-24eb7",
      storageBucket: "trainings-app-24eb7.appspot.com",
      messagingSenderId: "266317486009",
      appId: "1:266317486009:web:730e7f91eaae69fb584868",
      measurementId: "G-3EWQ7W9Z85",
      databaseURL: "https://trainings-app-24eb7-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase(app);

    let currentUser = null;
    const eintraege = [];
    const uebungen = [];

    // DOM Elements
    const emailInput = document.getElementById('emailInput');
    const passInput = document.getElementById('passInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const geraetSelect = document.getElementById('geraetSelect');
    const wdhInput = document.getElementById('wdh');
    const gewichtInput = document.getElementById('gewicht');
    const tbody = document.querySelector('#tabelle tbody');
    const tabelle = document.getElementById('tabelle');

    let geraetChart, wochenChart;

    // Login
    loginBtn.onclick = () => {
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      signInWithEmailAndPassword(auth, email, pass)
        .then(() => console.log("Angemeldet"))
        .catch(err => alert("Login-Fehler: " + err.message));
    };

    // Logout
    logoutBtn.onclick = () => {
      signOut(auth);
    };

    // User State Listener
    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        // Hide login, show logout
        document.getElementById('loginContainer').style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        loadEntries();
      } else {
        // Show login, hide logout
        document.getElementById('loginContainer').style.display = 'block';
        logoutBtn.style.display = 'none';
        eintraege.length = 0;
        tbody.innerHTML = '';
        tabelle.hidden = true;
      }
    });

    function loadEntries() {
      const eintraegeRef = ref(db, `users/${currentUser.uid}/eintraege`);
      onValue(eintraegeRef, snapshot => {
        eintraege.length = 0;
        tbody.innerHTML = '';
        snapshot.forEach(child => {
          const e = child.val();
          eintraege.unshift(e);
          addEntryToTable(e);
        });
        tabelle.hidden = eintraege.length === 0;
        if (document.getElementById('statsTab').classList.contains('active')) {
          renderCharts();
        }
      });
    }

    function addEntryToTable(e) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${e.datum}</td>
        <td>${e.geraet}</td>
        <td>${e.wdh}</td>
        <td>${e.gewicht} kg</td>
        <td><button onclick="this.closest('tr').remove()">🗑️</button></td>
      `;
      tbody.appendChild(row);
    }

    // Automatische Speicherung bei Änderung
    function saveCurrentEntry() {
      if (!currentUser) return;

      const geraet = geraetSelect.value;
      const wdh = Number(wdhInput.value);
      const gewicht = Number(gewichtInput.value);

      if (!geraet || !wdh || wdh <= 0 || isNaN(gewicht) || gewicht < 0) {
        return; // Ungültige Eingaben ignorieren
      }

      const now = new Date();
      const datum = now.toLocaleDateString('de-DE') + ' ' + now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      const eintrag = { datum, geraet, wdh, gewicht };

      // Firebase speichern
      const eintragRef = push(ref(db, `users/${currentUser.uid}/eintraege`));
      set(eintragRef, eintrag);
    }

    geraetSelect.addEventListener('change', saveCurrentEntry);
    wdhInput.addEventListener('input', saveCurrentEntry);
    gewichtInput.addEventListener('input', saveCurrentEntry);

    // Charts rendern (bleibt unverändert)
    function renderCharts() {
      const geraeteDaten = {};
      const wochen = {};

      eintraege.forEach(e => {
        const d = new Date(e.datum.split(' ')[0].split('.').reverse().join('-'));
        const kw = `${d.getFullYear()}-W${Math.ceil((d.getDate() + 6 - d.getDay()) / 7)}`;
        wochen[kw] = (wochen[kw] || 0) + 1;
        geraeteDaten[e.geraet] = geraeteDaten[e.geraet] || [];
        geraeteDaten[e.geraet].push({ x: e.datum, y: e.gewicht });
      });

      const geraetCtx = document.getElementById('geraetChart').getContext('2d');
      if (geraetChart) geraetChart.destroy();
      geraetChart = new Chart(geraetCtx, {
        type: 'line',
        data: {
          datasets: Object.keys(geraeteDaten).map(name => ({
            label: name,
            data: geraeteDaten[name],
            fill: false,
            borderColor: '#' + Math.floor(Math.random()*16777215).toString(16)
          }))
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'Gewichtsverlauf pro Gerät' } },
          scales: { x: { type: 'category', title: { display: true, text: 'Datum' } }, y: { title: { display: true, text: 'kg' } } }
        }
      });

      const wochenCtx = document.getElementById('wochenChart').getContext('2d');
      if (wochenChart) wochenChart.destroy();
      wochenChart = new Chart(wochenCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(wochen),
          datasets: [{
            label: 'Trainings/Woche',
            data: Object.values(wochen),
            backgroundColor: '#00c896'
          }]
        },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'Trainingshäufigkeit pro Woche' } },
          scales: { y: { beginAtZero: true, title: { display: true, text: 'Anzahl' } } }
        }
      });
    }

    // Tab wechseln (unverändert)
    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      if (tabId === 'statsTab') renderCharts();
    }
    window.switchTab = switchTab; // global für Buttons

  </script>

  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
      color: #fff;
      padding: 10px;
      max-width: 500px;
      margin: auto;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    #logoutBtn { display: none; }
    #loginContainer > * {
      display: block;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Trainings App</h1>

  <div id="loginContainer">
    <input id="emailInput" type="email" placeholder="E-Mail" />
    <input id="passInput" type="password" placeholder="Passwort" />
    <button id="loginBtn">Anmelden</button>
  </div>
  <button id="logoutBtn">Abmelden</button>

  <div class="tabs">
    <div class="tab-header">
      <button onclick="switchTab('statsTab')">📊 Statistiken</button>
      <button onclick="switchTab('formTab')">📋 Training</button>
    </div>

    <div id="statsTab" class="tab-content">
      <canvas id="geraetChart"></canvas>
      <canvas id="wochenChart"></canvas>
    </div>

    <div id="formTab" class="tab-content active">
      <label>Gerät:</label>
      <select id="geraetSelect"></select>
      <label>Wiederholungen:</label>
      <input type="number" id="wdh" min="1" />
      <label>Gewicht (kg):</label>
      <input type="number" id="gewicht" min="0" step="0.5" />
      <table id="tabelle" hidden>
        <thead><tr><th>Datum</th><th>Gerät</th><th>Wdh</th><th>Gewicht</th><th>Aktion</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</body>
</html>


